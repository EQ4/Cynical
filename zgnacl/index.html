<!DOCTYPE html>
<html>
<head>
	<title>Bruno!</title>
	<!-- Online
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" type="text/css" media="all" />
	<link rel="stylesheet" href="http://static.jquery.com/ui/css/demo-docs-theme/ui.theme.css" type="text/css" media="all" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
	<script src="http://code.jquery.com/ui/1.8.18/jquery-ui.min.js" type="text/javascript"></script>
	<script src="http://jquery-ui.googlecode.com/svn/tags/latest/external/jquery.bgiframe-2.1.2.js" type="text/javascript"></script>
	<script src="http://jquery-ui.googlecode.com/svn/tags/latest/ui/minified/i18n/jquery-ui-i18n.min.js" type="text/javascript"></script>
	-->
	 
	<!-- Local -->
	<link href="jquery/jquery-ui.css" type="text/css" rel="stylesheet" media="all" />
	<link href="jquery/ui.theme.css" type="text/css" rel="stylesheet" media="all" />
	<script src="jquery/jquery.min.js" type="text/javascript"></script>
	<script src="jquery/jquery-ui.min.js" type="text/javascript"></script>
	<script src="jquery/jquery.bgiframe-2.1.2.js" type="text/javascript"></script>
	<script src="jquery/jquery-ui-i18n.min.js" type="text/javascript"></script>
	
	<style>
		body {
			background: url('gfx/sky.jpg') fixed;
			color:white;
			font-family:arial,sans-serif;
			min-height: 672px;
			"""background: url('http://static.tumblr.com/jhhfv1l/UA5lqp7o2/sky.jpg') fixed;"""
			width:98%;
		}
		
		a:link {
			color: #C0C0C0;
		}
		a:visited {
			color: #C0C0C0;
		}
			
		#parent {  
			width: 1200px;
			text-align: center;  
			font-size: 12px;  
			letter-spacing: 0px;  
			white-space: nowrap;  
			line-height: 12px;  
			overflow: hidden;  
			color:white;
		}  
		
		.child {
			display: inline-block;  
			vertical-align: middle;  
		}
		
		h2 {
			color:white;
			font-family:arial,sans-serif;
		}
		
		.step {
			background-image: url('gfx/step-on.png');
			width: 32px;
			height: 32px;
			float:left;
			opacity:1;
		}
		
		.row1 {
			background-color: rgb(128,128,128);
			width: 512px;
			height: 32px;
			float:left;
			opacity:1;
			z-index: 100;
		}
		
		#demo-frame > div.demo { 
			padding: 10px !important; 
		}
		#eq span {
			height:120px; 
			float:left; 
			margin:15px
		}
		
		#slider-labels span {
			height:20px; 
			float:left; 
			margin:15px;
			width:15px;
			font-size: 12px;
			color: white;
			text-align: center;
		}
	</style>
	
	<script type="text/javascript">
    ZgnaclModule = null;  // Global application object.
			
    var loadPdPatch = function(url, callback){
        var args = Array.prototype.slice.call(arguments, 2);
        var loader = new XMLHttpRequest();
        var onLoad = function(e){
    	console.log(e);
        };
        loader.onreadystatechange = function(e){
    	if (e.target.readyState == 4) {
    	    callback.apply(callback, arguments);
    	}
        };
        loader.open("GET", url, false);
        loader.send(null);
    };
    
    function onPdPatchLoad(evt) {
        console.log(evt);
        ZgnaclModule.postMessage("newGraph: " + evt.target.responseText);
        ZgnaclModule.postMessage('playSound');
    }

    // When the NaCl module has loaded, hook up an event listener to handle
    // messages coming from it via PPB_Messaging.PostMessage() (in C) or
    // pp::Instance.PostMessage() (in C++), and indicate success.
    function moduleDidLoad() {
      ZgnaclModule = document.getElementById('zgnacl');
      ZgnaclModule.addEventListener('message', handleMessage, false);
      loadPdPatch("./osc4.pd", onPdPatchLoad);
      updateStatus('Ready!');
      for (i=0 ; i < 12 ; i++) {
      	registerReceiver("slider"+(i+1));
      };
      registerReceiver("key");
      registerReceiver("scale");
      
      // 
      document.getElementById('mouseArea').addEventListener('mousemove', sendMouseMove, true); 
      document.getElementById('mouseArea').addEventListener('mousedown', sendMouseDown, true);
	  document.addEventListener('mouseup', sendMouseDown, true);
     // document.getElementById('mouseArea').addEventListener('click', function(e){console.log(e);}, true);
    }
    
    function sendMouseMove(e) {
       sendMessage('mouseY', e.y);
       sendMessage('mouseX', e.x);
    }
    
	function sendMouseDown(m) {
		if (m.type == 'mousedown') {
			sendMessage('mouseDown', 1)
       }else{
			sendMessage('mouseDown', 0)
       }
    }

    // The 'message' event handler.  This handler is fired when the NaCl module
    // posts a message to the browser by calling PPB_Messaging.PostMessage()
    // (in C) or pp::Instance.PostMessage() (in C++).  This implementation
    // simply displays the content of the message in an alert panel.
	function handleMessage(message_event) {
		//alert(message_event.data);
		console.log(message_event.data);
		var message = new String(message_event.data);
		var messageType = (message.split(':')[0])
		var sender = (message.split(':')[1])
		var timestamp = (message.split(':')[2])
		var value = (message.split(':')[3]);
		
      	if (messageType == "receiveMessage"){
      		console.log('Received a message from '+sender+': '+value+' at '+timestamp);
      		updateSliderFromPd(sender, value);
      		if (sender == "scale") {
      			$("#scaleSelector").val(value);
      			// Because the above line of jquery doesn't send the value - only sets it for select boxes
      			sendMessage(sender+"Selector", value);
      		};
      		if (sender == "key") {
      			$("#keySelector").val(value);
      			sendMessage(sender+"Selector", value);
      		};
      	}
      	if (messageType == "printStd"){
      		console.log('Received a standard print from '+sender+': '+value+' at '+timestamp);
      	}
      	if (messageType == "printErr"){
      		console.log('Received an error: '+sender+': '+value+' at '+timestamp);
      	}
      	/*
		if (message.search("receiveMessage") != -1) {
			var messageType = (message.split(':')[0])
			var sender = (message.split(':')[1])
			var timestamp = (message.split(':')[2])
			var value = (message.split(':')[3]);
			updateSliderFromPd(sender, value)
		}
		*/
    }
    
    function pageDidLoad() {
      if (ZgnaclModule == null) {
        updateStatus('Loading synth... (may take up to a minute)');
      } else {
        // It's possible that the Native Client module onload event fired
        // before the page's onload event.  In this case, the status message
        // will reflect 'SUCCESS', but won't be displayed.  This call will
        // display the current message.
        updateStatus();
      }
    }

    // Set the global status message.  If the element with id 'statusField'
    // exists, then set its HTML to the status message as well.
    // opt_message The message test.  If this is null or undefined, then
    // attempt to set the element with id 'statusField' to the value of
    // |statusText|.
    function updateStatus(opt_message) {
      if (opt_message)
        statusText = opt_message;
      var statusField = document.getElementById('status_field');
      if (statusField) {
        statusField.innerHTML = statusText;
      }
    };
    
    function toggleSound(flag) {
      if (flag) {
        ZgnaclModule.postMessage('playSound');
      } else {
        ZgnaclModule.postMessage('stopSound');
      }
    };
    
    $(function() {
		// setup graphic EQ
		$( "#eq > span" ).each(function() {
			// read initial values from markup and remove that
			var value = parseInt( $( this ).text(), 10 );
			$( this ).empty().slider({
				value: value,
				range: "min",
				animate: true,
				orientation: "vertical",
				change: sendSlider,
				slide: sendSlider,
			});
		});
	});
	
	function updateSliderFromPd(sliderToUpdate, value) {
		var slider = $( "#"+sliderToUpdate );
		slider.slider( "value", value )
	};
	
	function sendSlider(sliderToUpdate, value) {
		sendMessage((this.id)+'s', $(this).slider("value"));
	};
        
	function sendMessage(receiverName, messageString) {
	  ZgnaclModule.postMessage("sendMessage:" + receiverName + ":0:" + messageString);
	  console.log('Sending '+messageString+' to '+receiverName);
	}

	function sendMessageWithTimestamp(receiverName, timestamp, messageString) {
	  ZgnaclModule.postMessage("sendMessage:" + receiverName + ":" + timestamp + ":" + messageString);
	}

	function registerReceiver(receiverName) {
	  ZgnaclModule.postMessage("registerReceiver:" + receiverName);
	}
	
	function unregisterReceiver(receiverName) {
	  ZgnaclModule.postMessage("unregisterReceiver:" + receiverName);
	}
  </script>
</head>
<body>
<!--
<button onclick="toggleSound(true)">Play</button>
<button onclick="toggleSound(false)">Stop</button>
-->
	<div id="listener">
		<script type="text/javascript">
		   document.getElementById('listener').addEventListener('load', moduleDidLoad, true);
		</script>
		
		<embed name="nacl_module"
		   id="zgnacl"
		   width=0 height=0
		   src="zgnacl_dbg.nmf" 
		   type="application/x-nacl" />
	</div>
	<center>
		<div id="title" style="opacity:1; width:780px; height:89PX; background-image:url('gfx/juno-title.png');"></div>
		<h2 id="status_field">Loading synth... (may take up to a minute)</h2>
	<center>
	<div style="width: 1200px; margin: 0 auto 0 auto;">
		<div id="parent">		
		<div style="clear:both;"></div>		
		<p class="child">Preset:</p>
		<select class="child" id="presetSelector" onchange="sendMessage('presetSelector', value);">
			<option value="0">Plain Sine</option>
			<option value="1">Spooky Sine</option>
			<option value="2">French Bass</option>
			<option value="3">Aliens Landing</option>
		</select>
		<div style="clear:both;"></div>			
		<div class="child">
		  	<p class="child">Scale:</p>
			<select class="child" id="scaleSelector" onchange="sendMessage('scaleSelector', value)">
				<option value="Chromatic">Chromatic</option>
				<option value="Blues">Blues</option>
				<option value="BluesDiminished">Blues Diminished</option>
				<option value="Dorian">Dorian</option>
				<option value="FullMinor">Full Minor</option>
				<option value="HarmonicMajor">Harmonic Major</option>
				<option value="Hawaiian">Hawaiian</option>
				<option value="IonianSharp5">Ionian Sharp 5</option>
				<option value="JazzMinor">Jazz Minor</option>
				<option value="Lydian">Lydian</option>
				<option value="Major">Major</option>
				<option value="Mixolydian">Mixolydian</option>
				<option value="Oriental">Oriental</option>
				<option value="SuperLocrian">Super Locrian</option>
				<option value="VerdiEnigmaticAscending">Verdi Enigmatic Ascending</option>
				<option value="Zirafkend">Zirafkend</option>
			</select>
		  	<p class="child">Key:</p>
			<select class="child" id="keySelector" onchange="sendMessage('keySelector', value);">
				<option value="0">C</option>
				<option value="1">C#</option>
				<option value="2">D</option>
				<option value="3">D#</option>
				<option value="4">E</option>
				<option value="5">F</option>
				<option value="6">F#</option>
				<option value="7">G</option>
				<option value="8">G#</option>
				<option value="9">A</option>
				<option value="10">A#</option>
				<option value="11">B</option>
			</select>
		  </div>
		</div>
		<div id="eq" class="child">
			<span id="slider1">100</span>
			<span id="slider2">100</span>
			<span id="slider3">0</span>
			<span id="slider4">33</span>
			<span id="slider5">40</span>
			<span id="slider6">45</span>
			<span id="slider7">70</span>
			<span id="slider8">33</span>
			<span id="slider9">0</span>
			<span id="slider10">45</span>
			<span id="slider11">0</span>
			<span id="slider12">0</span>
		</div>
		<div style="clear:both;"></div>
		<div id="slider-labels" class="child">
			<span>Volume</span>
			<span>OSC 1</span>
			<span>OSC 2</span>
			<span>Freq</span>
			<span>A</span>
			<span>D</span>
			<span>S</span>
			<span>R</span>
			<span>Delay</span>
			<span>Trem Rate</span>
			<span>Trem Depth</span>
		</div>
		<div style="clear:both;"><div>
		<div id="mouseArea" style="opacity:1; width:790px; height:235PX; background-image:url('gfx/juno.png');"></div>
		<div style="clear:both;"><div>
		<div id="instructions">
			<p>Drag left and right on the Juno to control the synth</p>
			<p>Note: NativeClient must be enabled for this to run correctly:</p>
			<p>Type <u>about:flags</u> and <u>about:plugins</u> into your address bar and enable <em>Native Client</em> on both pages. Restart Chrome.</p>
		</div>
		</div>
  	<div style="position:absolute; bottom:5px; left: 5px;">
  		<img src="http://reactifymusic.com/Cynical-Lab/chrome-trans.png">
  	</div>
  	<div style="position:absolute; bottom:5px; right: 5px;">
  		<p>Audio synthesis by <a href="https://github.com/mhroth/Cynical">Cynical</a></p>
  	</div>
</body>
</html>
